---
title: "How Well Do Crowdsourcers Map Individual Fields?"
author: "Lyndon Estes"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    toc_depth: 3
    toc: yes
vignette: >
  %\VignetteIndexEntry{Crowdsourcing project}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Data

There are four datasets for this project, which come bundled with this package.
```{r, message = FALSE}
library(geospaarproj)
library(geospaar)
library(rgdal)

# maps made by Mechanical Turk workers
f <- system.file("extdata/worker_fmaps.sqlite", package = "geospaarproj")
workers <- readOGR(dsn = f, layer = "worker_fmaps", verbose = FALSE)

# ground-truth
f <- system.file("extdata/truth_fmatch.sqlite", package = "geospaarproj")
truth <- readOGR(dsn = f, layer = "truth_fmatch", verbose = FALSE)

# assignment data
f <- system.file("extdata/fassignments.csv", package = "geospaarproj")
assn <- read.csv(f)

# sample grids
f <- system.file("extdata/fgrids_alb.sqlite", package = "geospaarproj")
fgrids <- readOGR(dsn = f, layer = "fgrids_alb", verbose = FALSE)
```

You will really just need three of these, but we provide the fourth for illustration purposes: 

- `workers` contains the maps of workers collected for 171 sample grids (workers were asked to map all fields within a 1 km$^2$ sample grid frame) where we also had collected the boundaries for one to several crop fields. For each of these sites, at least 20 workers were asked to map the location. This dataset has the following important variables names: 
    - "name" is the identifier of the sample grid the worker mapped (e.g. "ZM0726808");
    - "fieldname" is the identifier of the sample grid with the number of the individual field mapped at that grid by that worker appended to it (e.g. "ZM0726808_1", "ZM0726808_2", the first and second fields mapped in the grid by the worker);
    - "assignment_id" is the unique identifier for each worker's mapping efforts corresponding to a particular grid

- `truth` contains the GPS-collected field boundaries. It contains: 
    - "id", a unique identifier for the field
    - "name", the grid identifier it intersects with
    
    > Note: there are a number of field boundaries that intersect with multiple sample grids, so they have more than one record (and duplicate polygons to match) in this dataset

- `assn` contains a bunch of information collected by our mapping system, which includes the following important variables: 
    - "assignment_id", a unique identifier for each worker's mapping efforts corresponding to a particular grid 
    - "worker_id" is each worker's individual ID 
    - "name" is the identifier of the sample grid
    - "mapped_count" tells you how many times (i.e. how  many different workers) mapped the particular grid location
    
- `fgrids` is the polygon of the sampling grids themselves. You can use these to visualize how different fields in `workers` and `workers` overlap different sampling grids, which we will do below

```{r, fig.height=4, fig.width=7}
par(mfrow = c(1, 3), mar = c(0, 0, 1, 0))
plot(fgrids[fgrids$name %in% c("ZM0726808", "ZM0727304"), ], lty = 0, 
     main = "Worker Maps Vs Truth...")
plot(fgrids, col = "grey", add = TRUE)
plot(workers[workers$name %in% c("ZM0726808", "ZM0727304"), ], 
     add = TRUE, col = "pink")
raster::text(fgrids, labels = "name", col = "green4")
plot(truth, add = TRUE, col = "blue")

plot(fgrids[fgrids$name %in% c("ZM0726808", "ZM0727304"), ], lty = 0, 
     main = "...in Grid ZM0726808...")
plot(fgrids, col = "grey", add = TRUE)
plot(workers[workers$name == "ZM0726808", ], add = TRUE, col = "tan")
plot(truth[truth$name == "ZM0726808", ], add = TRUE, col = "blue")
raster::text(fgrids, labels = "name", col = "green4")

plot(fgrids[fgrids$name %in% c("ZM0726808", "ZM0727304"), ], lty = 0, 
     main = "..and Grid ZM0727304")
plot(fgrids, col = "grey", add = TRUE)
plot(workers[workers$name == "ZM0727304", ], add = TRUE, col = "orange")
plot(truth[truth$name == "ZM0727304", ], add = TRUE, col = "blue")
raster::text(fgrids, labels = "name", col = "green4")

```

The example here illustrates two sample grids (in grey, with names labelled in green) that share a GPS'd field boundary contained in `truth`. The left panels shows all the `worker` polygons that cover these two grids.  Note these are all piled up on top of one another because 20 workers mapped the same location. The middle panel shows just those `worker` fields that were done by the workers who mapped sample grid ZM0726808. The right panel shows the same for ZM0727304. 

The trick in this project is to do the following: 

```
For each ground truth polygon (i)
  Find the grids it intersects with (j)
    For each grid j, select the corresponding assignments mapped there (k)
      From each selected assignment k, find: 
        if there is a field in k that intersects truth polygon i:
          then calculate the accuracy statistics for that intersecting field:
            true positive area
            false positive area
            false negative area
        if there is no intersecting field, 
          then record: 
            false negative area
```

That gives the basic scope of the approach.  The resulting accuracy statistics will be collated and analyzed.  


