---
title: "Yield and planting date data"
author: "Lyndon Estes"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    toc_depth: 4
    toc: yes
vignette: >
  %\VignetteIndexEntry{Yields and planting dates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Overview

This vignette describes the datasets needed for two projects: variability in planting dates and yield prediction. It also refers to data that should be used in estimating the spatial variability of rainfall.

## Data

Two relevant datasets come bundled with this project.
```{r, message = FALSE}
library(geospaarproj)
library(geospaar)
library(rgdal)

# Household survey data 2015/2016
f <- system.file("extdata/yield_planting.csv", package = "geospaarproj")
hh <- read.csv(f, stringsAsFactors = FALSE)

# SMS survey 
f <- system.file("extdata/sms-data.csv", package = "geospaarproj")
sms <- read.csv(f, stringsAsFactors = FALSE)
```

The first dataset (`hh`) comes from a Zambia-wide household survey we did asking farmers a number of questions including their crop management data from the 2015-2016 growing season. It contains data related to crop yield and planting date variability that will be needed for the projects on predicting yields (project 2.3.6) and whether variability in farmers' planting dates is correlated with variability in rainfall (project 2.3.7). 

The second dataset contains the SMS survey data on rainfall response and planting dates. These data should be used by several projects also: yield prediction (2.3.6), where frequency of farmers reporting rainfall in a week can serve as a predictor of yields, and planting date variability can be used as an additional measure of planting date variability to supplement the data in `hh`. 

These data are described in more detail below:

## Data explained
### `hh` dataset

The `hh` dataset has the following variables
```{r}
hh[1, ]
```
The variables are as follows: 

- names: anonymized names of survey respondent
- lat: Latitude in decimal degrees
- lon: Longitude in decimal degrees
- seed: Kg of seed planted that season
- plot: farmers' estimate of their maize planted area for that season
- harv: farmers' reported harvest in kg
- unharv: 0 means their was no unharvested maize in the farmers' fields at the time of survey, 1 means that there was
- pd1: Date of first crop planting that season
- pd2: Date of second crop planting that season
- pd3: Date of third crop planting that season
- pd4: Date of fourth crop planting that season
- pd5: Date of fifth crop planting that season
- fert: The amount of fertilizer applied to the planted crops (*I think*)

#### Yield prediction

For the yield prediction project, the variables "seed", "plot", and "harv" are of interest.  Farmers are not that accurate in estimating their own planted area, so we use two methods to estimate their area of maize plantings, which we then use to divide "harv" to get yield in kg/ha: 

1. We divide "seed" by 20, which is based on the observation that about 20 kg of seed is used for one ha of maize, therefore seed / 20 gives an estimate of the number of planted ha

2. We simply use the reported "plot" area, which is the size of the plot planted to maize in ha. 

We should also filter our data. Since we have some responses (`r hh$unharv[hh$unharv == 1][1] / nrow(hh) * 100` percent, to be exact) in which the farmers said they still had unharvested crop in the field, that will bias our yield estimates. So we need to remove those from our sample. 

So, let's do that while look at the two ways of estimating planted area, and also how those two methods impact our yield estimates. 

```{r, fig.height=4, fig.width=7, fig.align='center'}
# remove all observations having unharvested crops, plus one suspiciously 
# large planted area value
hh2 <- hh[hh$plot < 100 & hh$unharv == 0, ]
plarea1 <- hh2$plot
plarea2 <- hh2$seed / 20  # convert seed estimate to ha
yield1 <- hh2$harv / plarea1  # type 1 yield
yield2 <- hh2$harv / plarea2  # type 2 yield


par(mfrow = c(1, 2))
plot(plarea1, plarea2, xlab = "Planted area (ha)", ylab = "kg seed / 20", 
     pch = 20, xlim = c(0, 20), ylim = c(0, 20), cex.axis = 0.8,
     main = "Planted area: Farmer ha vs seed ha", cex.main = 0.8)
# abline(lm(plarea2 ~ plarea1), lty = 2)
a <- c(0, 20)
b <- c(0, 20)
abline(lm(a ~ b))
estr <- paste("mean abs. error =", round(mean(abs(plarea1 - plarea2)), 2), 
              "ha")
mtext(text = estr, side = 3, line = -2, cex = 0.8)
estr <- paste("mean planted area =", round(mean(plarea1), 2), "ha")
mtext(text = estr, side = 3, line = -1, cex = 0.8)

plot(yield1, yield2, xlim = c(0, 25000), ylim = c(0, 25000), pch = 20, 
     main = "Yields: Farmer ha vs seed ha", cex.main = 0.8, cex.axis = 0.8)
a <- c(0, 25000)
b <- c(0, 25000)
abline(lm(a ~ b))

# statistics, after first removing NA and infinite values from yields
badylds <- c(which(is.na(yield1) | is.infinite(yield1)), 
             which(is.na(yield2) | is.infinite(yield2)))
mae <- round(mean(abs(yield1[-badylds] - yield2[-badylds])), 1)
muyld <- round(mean(yield1[-badylds]), 1)
estr <- paste("mean abs error =", mae, "kg/ha")
mtext(text = estr, side = 3, line = -2, cex = 0.8)
estr <- paste("mean yield =", muyld, "kg/ha")
mtext(text = estr, side = 3, line = -1, cex = 0.8)
```

So, there are two ways of calculating yields we see, and they each give somewhat different answers. Generally they are close to one another, but there are outliers. I would remove the observations where the two variants of planted area are quite different from one another (e.g. more than 30% different), and then use yields calculated from the remaining planted area.

So those area yield data, which is the response that you want to predict.  To predict yields, you will need predictors, such as rainfall and temperature. See the explanation on the `sms` dataset for ideas on that, plus some more on other variables you can download use from elswhere. 

#### Planting dates

There are 5 planting date variables in the `hh` dataset (pd1-pd5). However, the number of actual data values declines with quickly after pd1:

```{r}
for(i in grep("pd", names(hh))) {
  hh[, i] <- as.Date(hh[, i], "%Y-%m-%d")
}
apply(hh[, grep("pd", names(hh))], 2, function(x) {
  length(which(!is.na(x))) / length(x) * 100
})

```

That tells you the percent of non-NA values for each of the 5 potential plantings, which means that most farmers didn't plant more than one time. You will notice that I first coerced pd1-pd5 into the date class, as they were read into R as a character. 

These data will give you the ability to look at planting date variability throughout Zambia. It will give you a sense of how much variability there is within between individual farmers in different areas, and also how much the planting dates vary across the country. 

You will also be able to use to the planting date responses from the `sms` dataset, which we will cover next. 

### `sms` data
```{r}
sms[1, ]
```

The variables are as follows: 

- uuid: Unique identifier of survey respondent
- lat: Latitude in decimal degrees
- lon: Longitude in decimal degrees
- date: the last date in the 7 day interval that the farmers are reporting on
- season: 1 or 2. This allows you to easily subset observations that were collected during the 2015-2016 crop growing season (1), or 2016-2017 season (2)
- ra: This codes the answer to the question, did it rain on your fields this week, yes (1) or no (0). There are also many NA values, because the number of farmers who answer each week varies. There are responses for both season 1 and 2
- pl: Did you plant your crop this week, yes (1) or no (2). As with the above there are many NAs, and in this case there are also no responses at all for season 1. As with planting variables in the `hh` dataset, there might be farmers that responded yes more than once--in fact we can check this:

#### `sms` planting dates

```{r, fig.align="center", fig.height=4, fig.width = 4}
sms_ss <- sms[sms$season == 2, ]  # select just season 2
pls <- sapply(unique(sms_ss$uuid), function(x) {  # x <- unique(sms_ss$uuid)[3]
  pl <- sms_ss[sms_ss$uuid == x, "pl"]
  sum(pl, na.rm = TRUE)
})
hist(pls, xlab = "N plantings", main = "N plantings reported by farmer", 
     col = "blue")
```

So there are quite a few farmers reporting multiple planting dates. There are also quite a few who don't report at all. NA management will be particularly important in analysis of this dataset, which will complement analysis of planting date variability in the `hh` dataset.

#### `sms` rainfall

As with planting dates, we can look at how many weeks of rainfall were reported by farmers
```{r, fig.align="center", fig.height=4, fig.width = 7}
rasl <- lapply(1:2, function(x) {
  sms_ss <- sms[sms$season == x, ]  # select just season 2
  ras <- sapply(unique(sms_ss$uuid), function(y) {  
    ra <- sms_ss[sms_ss$uuid == y, "ra"]
    sum(ra, na.rm = TRUE)
  })
})
par(mfrow = c(1, 2))
cols <- c("green4", "blue")
yr <- c("2015/2016", "2016/2017")
for(i in 1:2) { 
  hist(rasl[[i]], xlab = "N rain weeks", 
       main = paste("N rain weeks in", yr[i]), col = cols[i])
}
```

There are two seasons worth of data in this case, so that's binary rainfall response variable that tells you whether it rained or not that week in a particular location.

This variable will be useful, possibly, for creating predictor variables for estimating yield, and also for estimating the spatial variability of rainfall. 

## Distribution of the datasets

Lastly, let's look at the spatial distributions of these data. 

```{r, fig.align="center", fig.height=4, fig.width = 4}
coordinates(hh) <- ~lon + lat
dat <- sms[sms$season == 1, ]
sms2015 <- do.call(rbind, lapply(unique(dat$uuid), function(x) {
  dat[dat$uuid == x, ][1, ]
}))
dat <- sms[sms$season == 2, ]
sms2016 <- do.call(rbind, lapply(unique(dat$uuid), function(x) {
  dat[dat$uuid == x, ][1, ]
}))
coordinates(sms2015) <- ~lon + lat
coordinates(sms2016) <- ~lon + lat

data("districts", package = "geospaar")
par(mar = c(0, 0, 0, 0))
plot(districts, col = "grey")
points(hh, pch = 20, col = "green4", cex = 1.5)
points(sms2015, pch = 20, col = "red")
points(sms2016, pch = "+", col = "blue", cex = 0.5)
```

The `hh` survey data and the 2016 `sms` dataset are largely from the same areas, and most likely from the same farmers in many cases (but not all). The 2015 `sms` data are much more limited in extent. 





